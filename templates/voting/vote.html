{% extends 'base.html' %}

{% block title %}Votar - Sabios Awards{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h1>Votación {{ period.month }}/{{ period.year }}</h1>
        <p class="lead">Elige al MVP del mes. Solo puedes votar una vez.</p>
    </div>
</div>

<form method="post" id="voteForm">
    {% csrf_token %}
    <div class="row g-4 justify-content-center">
        {% for candidate in candidates %}
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 candidate-card-container border-0 bg-transparent">
                <div class="flip-card" onclick="this.classList.toggle('flipped')">
                    <div class="flip-card-inner">
                        <div class="flip-card-front card shadow-sm h-100">
                            {% if candidate.photo %}
                            <img src="{{ candidate.photo.url }}" class="card-img-top" alt="{{ candidate.name }}"
                                style="height: 300px; object-fit: cover;">
                            {% else %}
                            <div class="bg-secondary text-white d-flex align-items-center justify-content-center"
                                style="height: 300px;">
                                <span>Sin Foto</span>
                            </div>
                            {% endif %}
                            <div class="card-img-overlay d-flex align-items-end gradient-overlay">
                                <h5 class="card-title text-white fw-bold mb-0 text-shadow">{{ candidate.name }}</h5>
                            </div>
                            <div class="position-absolute top-0 end-0 p-2">
                                <span class="badge bg-light text-dark opacity-75">Click para info</span>
                            </div>
                        </div>
                        <div
                            class="flip-card-back card shadow-sm h-100 bg-dark text-white p-4 d-flex align-items-center justify-content-center text-center">
                            <div>
                                <h5 class="fw-bold mb-3">{{ candidate.name }}</h5>
                                <p class="small">{{ candidate.nomination_reason|default:"Sin motivos especificados para esta nominación." }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <!-- Added data attributes for JS -->
                    <input type="radio" class="btn-check" name="candidate" id="cand_{{ candidate.id }}"
                        value="{{ candidate.id }}" data-name="{{ candidate.name }}"
                        data-photo="{% if candidate.photo %}{{ candidate.photo.url }}{% endif %}" required>
                    <label class="btn btn-outline-light w-100 fw-bold" for="cand_{{ candidate.id }}">
                        Votar por {{ candidate.name }}
                    </label>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center">
            <p class="text-muted">No hay candidatos definidos para esta votación.</p>
        </div>
        {% endfor %}
    </div>

    {% if candidates %}
    <div class="row mt-5">
        <div class="col-12 text-center">
            <!-- Changed to type="button" to trigger modal -->
            <button type="button" class="btn btn-warning btn-lg px-5 fw-bold text-dark shadow-sm"
                onclick="prepareVoteConfirmation()">Confirmar Selección</button>
            <div class="mt-3">
                <a href="{% url 'dashboard' %}" class="text-muted text-decoration-none">Cancelar</a>
            </div>
        </div>
    </div>
    {% endif %}
</form>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-warning confirmation-modal-content">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Confirmar MVP</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="lead mb-4">¿Estás 100% seguro de tu elección?</p>

                <div id="modalCandidateInfo" class="mb-4 d-flex flex-column align-items-center">
                    <div class="image-wrapper mb-3">
                        <img id="modalCandidateImg" src="" class="rounded-circle shadow-lg" alt="Candidato">
                        <div class="placeholder-img rounded-circle shadow-lg d-flex align-items-center justify-content-center bg-secondary"
                            id="modalPlaceholderImg" style="display: none;">
                            <span class="fs-1">?</span>
                        </div>
                    </div>
                    <h3 id="modalCandidateName" class="fw-bold text-warning text-uppercase letter-spacing-1">Nombre</h3>
                </div>

                <p class="small text-muted fst-italic">"Un gran poder conlleva una gran responsabilidad"</p>
            </div>
            <div class="modal-footer border-secondary justify-content-center gap-3">
                <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">Lo pensaré
                    mejor</button>
                <button type="button" class="btn btn-warning fw-bold px-4 pulse-animation" id="finalVoteBtn">¡CONFIRMAR
                    VOTO!</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Flip Card CSS */
    .flip-card {
        background-color: transparent;
        height: 300px;
        perspective: 1000px;
        cursor: pointer;
    }

    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 10px;
        overflow: hidden;
    }

    .flip-card-back {
        transform: rotateY(180deg);
        background: linear-gradient(145deg, #1a1a1a, #2c2c2c);
        border: 1px solid #444;
    }

    .gradient-overlay {
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        padding-bottom: 20px;
        padding-left: 15px;
    }

    .text-shadow {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    /* Btn Check Styles */
    .btn-outline-light:hover {
        color: #000;
        background-color: #f8f9fa;
    }

    .btn-check:checked+.btn-outline-light {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
    }

    /* Override global card styles to prevent interference */
    .candidate-card-container.card:hover {
        transform: none !important;
        box-shadow: none !important;
    }

    .flip-card-front.card:hover {
        transform: none !important;
    }

    .flip-card-back.card:hover {
        transform: rotateY(180deg) !important;
    }

    /* Modal Styles */
    .confirmation-modal-content {
        box-shadow: 0 0 50px rgba(255, 193, 7, 0.2);
    }

    .image-wrapper img,
    .image-wrapper .placeholder-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border: 4px solid #ffc107;
    }

    .pulse-animation {
        animation: pulse-gold 2s infinite;
    }

    @keyframes pulse-gold {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }
</style>

<!-- Canvas Confetti Library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    function prepareVoteConfirmation() {
        const form = document.getElementById('voteForm');

        // Manual validation because the button is not type="submit"
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const selected = document.querySelector('input[name="candidate"]:checked');
        if (!selected) return; // Should be caught by validation, but just in case

        const name = selected.dataset.name;
        const photo = selected.dataset.photo;

        // Populate Modal
        document.getElementById('modalCandidateName').textContent = name;
        const img = document.getElementById('modalCandidateImg');
        const placeholder = document.getElementById('modalPlaceholderImg');

        if (photo) {
            img.src = photo;
            // Show image, hide placeholder
            img.classList.remove('d-none');
            img.classList.add('d-block');

            placeholder.classList.add('d-none');
            placeholder.classList.remove('d-flex');
        } else {
            // Hide image, show placeholder
            img.classList.add('d-none');
            img.classList.remove('d-block');

            placeholder.classList.remove('d-none');
            placeholder.classList.add('d-flex');
        }

        // Show Modal
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
    }

    document.getElementById('finalVoteBtn').addEventListener('click', function () {
        // Disable button to prevent double clicks
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '¡Registrando...!';

        // Confetti Explosion!
        const duration = 2000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 2000 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function () {
            const timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            const particleCount = 50 * (timeLeft / duration);

            // Since particles fall down, start a bit higher than random
            confetti(Object.assign({}, defaults, {
                particleCount,
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
                colors: ['#ffc107', '#ffffff', '#ffd700']
            }));
            confetti(Object.assign({}, defaults, {
                particleCount,
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
                colors: ['#ffc107', '#ffffff', '#ffd700']
            }));
        }, 250);

        // Fire a big one from the center too
        confetti({
            origin: { y: 0.7 },
            zIndex: 2001,
            particleCount: 150,
            spread: 100,
            colors: ['#ffc107', '#ffffff']
        });

        // Submit form after observing the glory
        setTimeout(() => {
            document.getElementById('voteForm').submit();
        }, 1500);
    });
</script>
{% endblock %}