{% extends 'base.html' %}

{% block title %}Dashboard - Sabios Awards{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="fw-bold">Panel de Control</h1>
        <p class="text-muted">Bienvenido a la plataforma de votaci√≥n MVP.</p>
    </div>
</div>

<div class="row g-4">
    <!-- Voting Card -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 border-primary border-2">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h3 class="card-title text-primary">Votaci√≥n del Mes</h3>
                {% if current_period %}
                <p class="card-text">Periodo: {{ current_period.month }}/{{ current_period.year }}</p>
                {% if has_voted %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Ya has votado
                </div>
                <p class="text-muted small mt-auto">Los resultados se revelar√°n el d√≠a 1 del pr√≥ximo mes.</p>
                {% else %}
                <p class="text-success fw-bold">¬°Votaci√≥n Abierta!</p>
                <a href="{% url 'cast_vote' %}" class="btn btn-primary btn-lg mt-auto">Votar Ahora</a>
                {% endif %}
                {% else %}
                <p class="text-muted">No hay votaci√≥n activa en este momento.</p>
                <button class="btn btn-secondary mt-auto" disabled>Votaci√≥n Cerrada</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Previous Winner Card -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <h3 class="card-title">Ganador Anterior</h3>
                {% if last_winner_period %}
                <p class="text-muted">{{ last_winner_period.month }}/{{ last_winner_period.year }}</p>
                {% with photo=last_winner_period.resolved_winner_photo %}
                {% if photo %}
                <img src="{{ photo.url }}" class="img-fluid rounded mb-3" style="max-height: 150px; object-fit: cover;">
                {% else %}
                <div class="bg-light rounded mb-3 d-flex align-items-center justify-content-center"
                    style="height: 150px;">
                    <span class="text-muted">Sin foto</span>
                </div>
                {% endif %}
                {% endwith %}
                <a href="{% url 'period_results' last_winner_period.id %}"
                    class="btn btn-outline-primary w-100 mb-2">Ver
                    Detalles</a>
                <a href="{% url 'hall_of_fame' %}" class="btn btn-warning w-100">üèÜ Ver Sal√≥n de la Fama</a>
                {% else %}
                <p class="text-muted mt-4">A√∫n no hay ganadores hist√≥ricos.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- My Profile / History -->
    <div class="col-md-6 col-lg-4">
        <div class="card h-100">
            <div class="card-header fw-bold">Mi Historial de Votos</div>
            <ul class="list-group list-group-flush">
                {% for vote in user_votes %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="text-white">
                        {{ vote.period.month }}/{{ vote.period.year }}
                    </span>
                    <span class="badge bg-light text-white">{{ vote.candidate.name }}</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted text-center">No has votado a√∫n.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Community Stats Section -->
<div class="row mt-5 mb-4">
    <div class="col-12">
        <h3 class="fw-bold mb-3 border-bottom pb-2">üìä Estad√≠sticas de la Comunidad</h3>
    </div>

    <!-- Top Voters -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-warning text-dark fw-bold">
                üó≥Ô∏è Top Votantes
            </div>
            <ul class="list-group list-group-flush">
                {% for u in top_voters %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        {% if forloop.first %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% endif %}
                        {{ u.username }}
                    </span>
                    <span class="badge bg-primary rounded-pill">{{ u.total_votes }} votos</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Sin datos.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Most Logins -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white fw-bold">
                üî• M√°s Fieles (Logins)
            </div>
            <ul class="list-group list-group-flush">
                {% for u in most_logins %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ u.username }}</span>
                    <span class="badge bg-success rounded-pill">{{ u.profile.login_count }} veces</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Sin datos.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Least Logins -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-secondary text-white fw-bold">
                üëª Fantasmas (Menos Logins)
            </div>
            <ul class="list-group list-group-flush">
                {% for u in least_logins %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="text-muted">{{ u.username }}</span>
                    <span class="badge bg-secondary rounded-pill">{{ u.profile.login_count }} veces</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Sin datos.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{% if is_admin %}
<div class="row mt-5">
    <div class="col-12">
        <div class="card bg-light border-danger">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title text-danger">Zona de Administraci√≥n</h5>
                    <p class="card-text mb-0">Gestiona votaciones, candidatos y estad√≠sticas.</p>
                </div>
                <a href="{% url 'admin_dashboard' %}" class="btn btn-danger">Entrar como Admin</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if show_intro %}
<!-- Intro Video Overlay -->
<div id="intro-overlay"
    class="position-fixed top-0 start-0 w-100 h-100 bg-black d-flex justify-content-center align-items-center"
    style="z-index: 9999;">

    <!-- Removed 'muted' to allow sound. Removed 'autoplay' to handle it via JS for consistency -->
    <video id="intro-video" class="w-100 h-100" style="object-fit: cover;" playsinline>
        <source src="https://res.cloudinary.com/dpqalrq6d/video/upload/v1765221847/videoSabiosAwards_fdz5uh.mp4"
            type="video/mp4">
        Tu navegador no soporta videos HTML5.
    </video>

    <!-- Start Button (Hidden by default, shown if autoplay fails) -->
    <button id="start-btn"
        class="btn btn-warning btn-lg position-absolute rounded-pill fw-bold px-5 py-3 shadow-lg pulse-animation"
        style="z-index: 10001; display: none;">
        üé¨ INICIAR GALA
    </button>

    <button id="skip-btn"
        class="btn btn-outline-light position-absolute bottom-0 end-0 m-5 px-4 py-2 rounded-pill border-2 fw-bold"
        style="z-index: 10000;">
        SALTAR INTRO
    </button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const overlay = document.getElementById('intro-overlay');
        const video = document.getElementById('intro-video');
        const skipBtn = document.getElementById('skip-btn');
        const startBtn = document.getElementById('start-btn');

        function closeIntro() {
            overlay.style.transition = 'opacity 1s ease';
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.remove();
            }, 1000);
        }

        video.addEventListener('ended', closeIntro);

        skipBtn.addEventListener('click', function () {
            video.pause();
            closeIntro();
        });

        startBtn.addEventListener('click', function () {
            startBtn.style.display = 'none';
            video.play();
            video.muted = false; // Ensure unmuted
        });

        // Attempt automatic playback with sound
        video.muted = false;
        const playPromise = video.play();

        if (playPromise !== undefined) {
            playPromise.then(_ => {
                // Auto-play started successfully!
            })
                .catch(error => {
                    // Auto-play was prevented. Show a UI element to let the user manually start playback.
                    console.log("Autoplay prevented (policy). Showing start button.");
                    startBtn.style.display = 'block';
                    // We could also try muting and playing, but the user wants sound.
                    // So we wait for the click.
                });
        }
    });
</script>

<style>
    .pulse-animation {
        animation: pulse-gold 2s infinite;
    }

    @keyframes pulse-gold {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 20px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
    }
</style>
{% endif %}

{% endblock %}